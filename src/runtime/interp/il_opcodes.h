#pragma once

#include "rt_managed_types.h"
#include "interp_defs.h"

namespace leanclr::interp::il
{
enum class OpCodeValue : uint8_t
{
    //{{OPCODE_VALUE
    Nop = 0x00,
    Break = 0x01,
    LdArg0 = 0x02,
    LdArg1 = 0x03,
    LdArg2 = 0x04,
    LdArg3 = 0x05,
    LdLoc0 = 0x06,
    LdLoc1 = 0x07,
    LdLoc2 = 0x08,
    LdLoc3 = 0x09,
    StLoc0 = 0x0A,
    StLoc1 = 0x0B,
    StLoc2 = 0x0C,
    StLoc3 = 0x0D,
    LdArgS = 0x0E,
    LdArgaS = 0x0F,
    StArgS = 0x10,
    LdLocS = 0x11,
    LdLocaS = 0x12,
    StLocS = 0x13,
    LdNull = 0x14,
    LdcI4M1 = 0x15,
    LdcI40 = 0x16,
    LdcI41 = 0x17,
    LdcI42 = 0x18,
    LdcI43 = 0x19,
    LdcI44 = 0x1A,
    LdcI45 = 0x1B,
    LdcI46 = 0x1C,
    LdcI47 = 0x1D,
    LdcI48 = 0x1E,
    LdcI4S = 0x1F,
    LdcI4 = 0x20,
    LdcI8 = 0x21,
    LdcR4 = 0x22,
    LdcR8 = 0x23,
    Unused99 = 0x24,
    Dup = 0x25,
    Pop = 0x26,
    Jmp = 0x27,
    Call = 0x28,
    Calli = 0x29,
    Ret = 0x2A,
    BrS = 0x2B,
    BrfalseS = 0x2C,
    BrtrueS = 0x2D,
    BeqS = 0x2E,
    BgeS = 0x2F,
    BgtS = 0x30,
    BleS = 0x31,
    BltS = 0x32,
    BneUnS = 0x33,
    BgeUnS = 0x34,
    BgtUnS = 0x35,
    BleUnS = 0x36,
    BltUnS = 0x37,
    Br = 0x38,
    Brfalse = 0x39,
    Brtrue = 0x3A,
    Beq = 0x3B,
    Bge = 0x3C,
    Bgt = 0x3D,
    Ble = 0x3E,
    Blt = 0x3F,
    BneUn = 0x40,
    BgeUn = 0x41,
    BgtUn = 0x42,
    BleUn = 0x43,
    BltUn = 0x44,
    Switch = 0x45,
    LdIndI1 = 0x46,
    LdIndU1 = 0x47,
    LdIndI2 = 0x48,
    LdIndU2 = 0x49,
    LdIndI4 = 0x4A,
    LdIndU4 = 0x4B,
    LdIndI8 = 0x4C,
    LdIndI = 0x4D,
    LdIndR4 = 0x4E,
    LdIndR8 = 0x4F,
    LdIndRef = 0x50,
    StIndRef = 0x51,
    StIndI1 = 0x52,
    StIndI2 = 0x53,
    StIndI4 = 0x54,
    StIndI8 = 0x55,
    StIndR4 = 0x56,
    StIndR8 = 0x57,
    Add = 0x58,
    Sub = 0x59,
    Mul = 0x5A,
    Div = 0x5B,
    DivUn = 0x5C,
    Rem = 0x5D,
    RemUn = 0x5E,
    And = 0x5F,
    Or = 0x60,
    Xor = 0x61,
    Shl = 0x62,
    Shr = 0x63,
    ShrUn = 0x64,
    Neg = 0x65,
    Not = 0x66,
    ConvI1 = 0x67,
    ConvI2 = 0x68,
    ConvI4 = 0x69,
    ConvI8 = 0x6A,
    ConvR4 = 0x6B,
    ConvR8 = 0x6C,
    ConvU4 = 0x6D,
    ConvU8 = 0x6E,
    Callvirt = 0x6F,
    Cpobj = 0x70,
    Ldobj = 0x71,
    Ldstr = 0x72,
    Newobj = 0x73,
    Castclass = 0x74,
    Isinst = 0x75,
    ConvRUn = 0x76,
    Unused58 = 0x77,
    Unused1 = 0x78,
    Unbox = 0x79,
    Throw = 0x7A,
    Ldfld = 0x7B,
    Ldflda = 0x7C,
    Stfld = 0x7D,
    Ldsfld = 0x7E,
    Ldsflda = 0x7F,
    Stsfld = 0x80,
    Stobj = 0x81,
    ConvOvfI1Un = 0x82,
    ConvOvfI2Un = 0x83,
    ConvOvfI4Un = 0x84,
    ConvOvfI8Un = 0x85,
    ConvOvfU1Un = 0x86,
    ConvOvfU2Un = 0x87,
    ConvOvfU4Un = 0x88,
    ConvOvfU8Un = 0x89,
    ConvOvfIUn = 0x8A,
    ConvOvfUUn = 0x8B,
    Box = 0x8C,
    Newarr = 0x8D,
    Ldlen = 0x8E,
    Ldelema = 0x8F,
    LdelemI1 = 0x90,
    LdelemU1 = 0x91,
    LdelemI2 = 0x92,
    LdelemU2 = 0x93,
    LdelemI4 = 0x94,
    LdelemU4 = 0x95,
    LdelemI8 = 0x96,
    LdelemI = 0x97,
    LdelemR4 = 0x98,
    LdelemR8 = 0x99,
    LdelemRef = 0x9A,
    StelemI = 0x9B,
    StelemI1 = 0x9C,
    StelemI2 = 0x9D,
    StelemI4 = 0x9E,
    StelemI8 = 0x9F,
    StelemR4 = 0xA0,
    StelemR8 = 0xA1,
    StelemRef = 0xA2,
    Ldelem = 0xA3,
    Stelem = 0xA4,
    UnboxAny = 0xA5,
    Unused5 = 0xA6,
    Unused6 = 0xA7,
    Unused7 = 0xA8,
    Unused8 = 0xA9,
    Unused9 = 0xAA,
    Unused10 = 0xAB,
    Unused11 = 0xAC,
    Unused12 = 0xAD,
    Unused13 = 0xAE,
    Unused14 = 0xAF,
    Unused15 = 0xB0,
    Unused16 = 0xB1,
    Unused17 = 0xB2,
    ConvOvfI1 = 0xB3,
    ConvOvfU1 = 0xB4,
    ConvOvfI2 = 0xB5,
    ConvOvfU2 = 0xB6,
    ConvOvfI4 = 0xB7,
    ConvOvfU4 = 0xB8,
    ConvOvfI8 = 0xB9,
    ConvOvfU8 = 0xBA,
    Unused50 = 0xBB,
    Unused18 = 0xBC,
    Unused19 = 0xBD,
    Unused20 = 0xBE,
    Unused21 = 0xBF,
    Unused22 = 0xC0,
    Unused23 = 0xC1,
    Refanyval = 0xC2,
    Ckfinite = 0xC3,
    Unused24 = 0xC4,
    Unused25 = 0xC5,
    Mkrefany = 0xC6,
    Unused59 = 0xC7,
    Unused60 = 0xC8,
    Unused61 = 0xC9,
    Unused62 = 0xCA,
    Unused63 = 0xCB,
    Unused64 = 0xCC,
    Unused65 = 0xCD,
    Unused66 = 0xCE,
    Unused67 = 0xCF,
    Ldtoken = 0xD0,
    ConvU2 = 0xD1,
    ConvU1 = 0xD2,
    ConvI = 0xD3,
    ConvOvfI = 0xD4,
    ConvOvfU = 0xD5,
    AddOvf = 0xD6,
    AddOvfUn = 0xD7,
    MulOvf = 0xD8,
    MulOvfUn = 0xD9,
    SubOvf = 0xDA,
    SubOvfUn = 0xDB,
    Endfinally = 0xDC,
    Leave = 0xDD,
    LeaveS = 0xDE,
    StIndI = 0xDF,
    ConvU = 0xE0,
    Unused26 = 0xE1,
    Unused27 = 0xE2,
    Unused28 = 0xE3,
    Unused29 = 0xE4,
    Unused30 = 0xE5,
    Unused31 = 0xE6,
    Unused32 = 0xE7,
    Unused33 = 0xE8,
    Unused34 = 0xE9,
    Unused35 = 0xEA,
    Unused36 = 0xEB,
    Unused37 = 0xEC,
    Unused38 = 0xED,
    Unused39 = 0xEE,
    Unused40 = 0xEF,
    Unused41 = 0xF0,
    Unused42 = 0xF1,
    Unused43 = 0xF2,
    Unused44 = 0xF3,
    Unused45 = 0xF4,
    Unused46 = 0xF5,
    Unused47 = 0xF6,
    Unused48 = 0xF7,
    Prefix7 = 0xF8,
    Prefix6 = 0xF9,
    Prefix5 = 0xFA,
    Prefix4 = 0xFB,
    Prefix3 = 0xFC,
    Prefix2 = 0xFD,
    Prefix1 = 0xFE,
    Prefixref = 0xFF,

    //}}OPCODE_VALUE
};

enum class OpCodeValueExt : uint8_t
{
    //{{OPCODE_VALUE_EXT
    Arglist = 0x00,
    Ceq = 0x01,
    Cgt = 0x02,
    CgtUn = 0x03,
    Clt = 0x04,
    CltUn = 0x05,
    Ldftn = 0x06,
    Ldvirtftn = 0x07,
    Unused56 = 0x08,
    Ldarg = 0x09,
    Ldarga = 0x0A,
    Starg = 0x0B,
    Ldloc = 0x0C,
    Ldloca = 0x0D,
    Stloc = 0x0E,
    Localloc = 0x0F,
    Unused57 = 0x10,
    Endfilter = 0x11,
    Unaligned = 0x12,
    Volatile = 0x13,
    Tail = 0x14,
    Initobj = 0x15,
    Constrained = 0x16,
    Cpblk = 0x17,
    Initblk = 0x18,
    No = 0x19,
    Rethrow = 0x1A,
    Unused = 0x1B,
    Sizeof = 0x1C,
    Refanytype = 0x1D,
    Readonly = 0x1E,
    Unused53 = 0x1F,
    Unused54 = 0x20,
    Unused55 = 0x21,
    Unused70 = 0x22,

    //}}OPCODE_VALUE_EXT
};

enum class OpCodePrefix : uint8_t
{
    None = 0x0,
    Constrained = 0x1,
    No = 0x2,
    ReadOnly = 0x4,
    Tail = 0x8,
    Volatile = 0x10,
    Unaligned = 0x20,
};

enum OpCodeEnum
{
    //{{OPCODE_ENUM
    Nop,
    Break,
    LdArg0,
    LdArg1,
    LdArg2,
    LdArg3,
    LdLoc0,
    LdLoc1,
    LdLoc2,
    LdLoc3,
    StLoc0,
    StLoc1,
    StLoc2,
    StLoc3,
    LdArgS,
    LdArgaS,
    StArgS,
    LdLocS,
    LdLocaS,
    StLocS,
    LdNull,
    LdcI4M1,
    LdcI40,
    LdcI41,
    LdcI42,
    LdcI43,
    LdcI44,
    LdcI45,
    LdcI46,
    LdcI47,
    LdcI48,
    LdcI4S,
    LdcI4,
    LdcI8,
    LdcR4,
    LdcR8,
    Unused99,
    Dup,
    Pop,
    Jmp,
    Call,
    Calli,
    Ret,
    BrS,
    BrfalseS,
    BrtrueS,
    BeqS,
    BgeS,
    BgtS,
    BleS,
    BltS,
    BneUnS,
    BgeUnS,
    BgtUnS,
    BleUnS,
    BltUnS,
    Br,
    Brfalse,
    Brtrue,
    Beq,
    Bge,
    Bgt,
    Ble,
    Blt,
    BneUn,
    BgeUn,
    BgtUn,
    BleUn,
    BltUn,
    Switch,
    LdIndI1,
    LdIndU1,
    LdIndI2,
    LdIndU2,
    LdIndI4,
    LdIndU4,
    LdIndI8,
    LdIndI,
    LdIndR4,
    LdIndR8,
    LdIndRef,
    StIndRef,
    StIndI1,
    StIndI2,
    StIndI4,
    StIndI8,
    StIndR4,
    StIndR8,
    Add,
    Sub,
    Mul,
    Div,
    DivUn,
    Rem,
    RemUn,
    And,
    Or,
    Xor,
    Shl,
    Shr,
    ShrUn,
    Neg,
    Not,
    ConvI1,
    ConvI2,
    ConvI4,
    ConvI8,
    ConvR4,
    ConvR8,
    ConvU4,
    ConvU8,
    Callvirt,
    Cpobj,
    Ldobj,
    Ldstr,
    Newobj,
    Castclass,
    Isinst,
    ConvRUn,
    Unused58,
    Unused1,
    Unbox,
    Throw,
    Ldfld,
    Ldflda,
    Stfld,
    Ldsfld,
    Ldsflda,
    Stsfld,
    Stobj,
    ConvOvfI1Un,
    ConvOvfI2Un,
    ConvOvfI4Un,
    ConvOvfI8Un,
    ConvOvfU1Un,
    ConvOvfU2Un,
    ConvOvfU4Un,
    ConvOvfU8Un,
    ConvOvfIUn,
    ConvOvfUUn,
    Box,
    Newarr,
    Ldlen,
    Ldelema,
    LdelemI1,
    LdelemU1,
    LdelemI2,
    LdelemU2,
    LdelemI4,
    LdelemU4,
    LdelemI8,
    LdelemI,
    LdelemR4,
    LdelemR8,
    LdelemRef,
    StelemI,
    StelemI1,
    StelemI2,
    StelemI4,
    StelemI8,
    StelemR4,
    StelemR8,
    StelemRef,
    Ldelem,
    Stelem,
    UnboxAny,
    Unused5,
    Unused6,
    Unused7,
    Unused8,
    Unused9,
    Unused10,
    Unused11,
    Unused12,
    Unused13,
    Unused14,
    Unused15,
    Unused16,
    Unused17,
    ConvOvfI1,
    ConvOvfU1,
    ConvOvfI2,
    ConvOvfU2,
    ConvOvfI4,
    ConvOvfU4,
    ConvOvfI8,
    ConvOvfU8,
    Unused50,
    Unused18,
    Unused19,
    Unused20,
    Unused21,
    Unused22,
    Unused23,
    Refanyval,
    Ckfinite,
    Unused24,
    Unused25,
    Mkrefany,
    Unused59,
    Unused60,
    Unused61,
    Unused62,
    Unused63,
    Unused64,
    Unused65,
    Unused66,
    Unused67,
    Ldtoken,
    ConvU2,
    ConvU1,
    ConvI,
    ConvOvfI,
    ConvOvfU,
    AddOvf,
    AddOvfUn,
    MulOvf,
    MulOvfUn,
    SubOvf,
    SubOvfUn,
    Endfinally,
    Leave,
    LeaveS,
    StIndI,
    ConvU,
    Unused26,
    Unused27,
    Unused28,
    Unused29,
    Unused30,
    Unused31,
    Unused32,
    Unused33,
    Unused34,
    Unused35,
    Unused36,
    Unused37,
    Unused38,
    Unused39,
    Unused40,
    Unused41,
    Unused42,
    Unused43,
    Unused44,
    Unused45,
    Unused46,
    Unused47,
    Unused48,
    Prefix7,
    Prefix6,
    Prefix5,
    Prefix4,
    Prefix3,
    Prefix2,
    Prefix1,
    Prefixref,
    Arglist,
    Ceq,
    Cgt,
    CgtUn,
    Clt,
    CltUn,
    Ldftn,
    Ldvirtftn,
    Unused56,
    Ldarg,
    Ldarga,
    Starg,
    Ldloc,
    Ldloca,
    Stloc,
    Localloc,
    Unused57,
    Endfilter,
    Unaligned,
    Volatile,
    Tail,
    Initobj,
    Constrained,
    Cpblk,
    Initblk,
    No,
    Rethrow,
    Unused,
    Sizeof,
    Refanytype,
    Readonly,
    Unused53,
    Unused54,
    Unused55,
    Unused70,
    Illegal,
    Endmac,

    //}}OPCODE_ENUM
};

enum class FlowType
{
    Next,
    Branch,
    CondBranch,
    Call,
    Return,
    Meta,
    Throw,
    Break,
};

enum class ArgType
{
    None,
    Data,
    StaticBranch,
    BranchTarget,
    Switch,
};

enum class InputType
{
    None,
};

enum class OutputType
{
    None,
};

enum class OpCodeKind
{
    Primitive,
    ObjModel,
    Macro,
    Prefix,
    Nternal,
};

struct OpCodeInfo
{
    OpCodeEnum id;
    // OutputType output; // reserved by original Rust code
    ArgType inline_type;
    int32_t inline_param;
    uint8_t code1;
    uint8_t code2;
    FlowType flow_type;
    int32_t const_value;
};

class OpCodes
{
  public:
    static const OpCodeInfo* get_opcode_info(OpCodeEnum opcode);
    static bool try_decode_opcode_info(const uint8_t* codes_cur, const uint8_t* codes_end, const OpCodeInfo*& out_opcode_info);
    static size_t get_opcode_size(const uint8_t* codes_cur, const OpCodeInfo* opcode_info);
};
} // namespace leanclr::interp::il
